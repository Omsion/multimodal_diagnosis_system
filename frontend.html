<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>多模态智能诊断系统 - 糖尿病视网膜病变检测</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .glass-morphism {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .loader {
      border: 3px solid #f3f4f6;
      border-top: 3px solid #3b82f6;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .drag-active {
      border-color: #3b82f6 !important;
      background-color: #eff6ff !important;
    }
    .severity-0 { color: #10b981; }
    .severity-1 { color: #eab308; }
    .severity-2 { color: #f97316; }
    .severity-3 { color: #ef4444; }
    .severity-4 { color: #dc2626; }
    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .status-online {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .progress-bar {
      transition: width 0.3s ease;
    }
    .result-card {
      transition: all 0.3s ease;
    }
    .result-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body class="gradient-bg min-h-screen">
  <div class="container mx-auto px-4 py-8 max-w-6xl">
    <!-- Header -->
    <header class="text-center mb-8">
      <div class="inline-flex items-center justify-center mb-4">
        <div class="bg-white rounded-full p-3 shadow-lg">
          <i class="fas fa-eye text-3xl text-blue-600"></i>
        </div>
      </div>
      <h1 class="text-4xl font-bold text-white mb-2">多模态智能诊断系统</h1>
      <p class="text-white/80 text-lg">基于AI的糖尿病视网膜病变检测与诊断平台</p>
    </header>

    <!-- Main Card -->
    <div class="glass-morphism rounded-2xl shadow-2xl p-8">
      <!-- API Configuration & Health Check -->
      <div class="mb-8 bg-gray-50 rounded-xl p-6">
        <div class="flex flex-col lg:flex-row lg:items-center gap-4">
          <div class="flex-1">
            <label for="apiUrl" class="block text-sm font-medium text-gray-700 mb-2">
              <i class="fas fa-server mr-1"></i> API服务器地址
            </label>
            <div class="flex gap-2">
              <input
                type="url"
                id="apiUrl"
                class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                placeholder="http://localhost:8000"
              >
              <button
                id="saveApiBtn"
                class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors"
              >
                <i class="fas fa-save mr-1"></i> 保存
              </button>
            </div>
          </div>

          <div class="flex flex-wrap gap-2">
            <button
              id="checkHealthBtn"
              class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
            >
              <i class="fas fa-heartbeat mr-1"></i> 健康检查
            </button>
            <button
              id="reloadKBBtn"
              class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors"
            >
              <i class="fas fa-sync-alt mr-1"></i> 重载知识库
            </button>
            <button
              id="viewLogsBtn"
              class="px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition-colors"
            >
              <i class="fas fa-file-alt mr-1"></i> 查看日志
            </button>
          </div>

          <div class="flex items-center">
            <div id="healthIndicator" class="w-3 h-3 bg-gray-400 rounded-full mr-2"></div>
            <span id="healthStatus" class="font-medium text-gray-700">状态未知</span>
          </div>
        </div>

        <!-- Model Status -->
        <div id="modelStatus" class="hidden mt-4 p-4 bg-white rounded-lg border">
          <h3 class="font-semibold mb-3 text-gray-800">
            <i class="fas fa-microchip mr-1"></i> 模型加载状态
          </h3>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
              <span class="text-sm font-medium">DR分级模型</span>
              <span id="statusDR" class="px-2 py-1 text-xs rounded-full"></span>
            </div>
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
              <span class="text-sm font-medium">Qwen-VL模型</span>
              <span id="statusQwen" class="px-2 py-1 text-xs rounded-full"></span>
            </div>
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
              <span class="text-sm font-medium">R1-7B模型</span>
              <span id="statusR1" class="px-2 py-1 text-xs rounded-full"></span>
            </div>
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
              <span class="text-sm font-medium">RAG知识库</span>
              <span id="statusRAG" class="px-2 py-1 text-xs rounded-full"></span>
            </div>
          </div>
        </div>
      </div>

      <!-- Upload Section -->
      <div class="mb-8">
        <div
          id="dropZone"
          class="border-3 border-dashed border-gray-300 rounded-xl p-8 text-center hover:border-blue-400 transition-colors cursor-pointer bg-gray-50"
        >
          <div class="mb-4">
            <i class="fas fa-cloud-upload-alt text-6xl text-gray-400"></i>
          </div>
          <h3 class="text-xl font-semibold mb-2 text-gray-700">上传眼底图像</h3>
          <p class="text-gray-500 mb-4">拖拽图片到此处或点击选择文件</p>
          <input
            type="file"
            id="imageInput"
            accept="image/*"
            class="hidden"
          >
          <button
            id="selectFileBtn"
            class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
          >
            <i class="fas fa-folder-open mr-2"></i> 选择文件
          </button>
          <div class="mt-4 text-sm text-gray-500">
            支持格式: JPG, PNG, BMP (最大10MB)
          </div>
        </div>

        <!-- Image Preview -->
        <div id="imagePreview" class="hidden mt-6 fade-in">
          <div class="bg-white rounded-lg shadow-lg overflow-hidden">
            <div class="p-4 bg-gray-50 border-b">
              <h4 class="font-semibold text-gray-800">
                <i class="fas fa-image mr-1"></i> 图像预览
              </h4>
            </div>
            <div class="p-4">
              <img id="previewImg" class="max-h-96 mx-auto rounded-lg shadow-md" alt="预览图像" />
              <div id="imageInfo" class="mt-4 text-sm text-gray-600"></div>
            </div>
          </div>
        </div>

        <!-- Settings -->
        <div class="mt-6 bg-gray-50 rounded-lg p-4">
          <h4 class="font-semibold mb-3 text-gray-800">
            <i class="fas fa-cog mr-1"></i> 诊断设置
          </h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <label class="flex items-center p-3 bg-white rounded-lg cursor-pointer hover:bg-gray-50 transition-colors">
              <input type="checkbox" id="enableRag" checked class="mr-3 h-4 w-4 text-blue-600">
              <div>
                <span class="font-medium">启用RAG知识检索</span>
                <p class="text-xs text-gray-500">使用医学知识库增强诊断</p>
              </div>
            </label>
            <label class="flex items-center p-3 bg-white rounded-lg cursor-pointer hover:bg-gray-50 transition-colors">
              <input type="checkbox" id="enableCot" checked class="mr-3 h-4 w-4 text-blue-600">
              <div>
                <span class="font-medium">启用CoT推理</span>
                <p class="text-xs text-gray-500">展示思维链推理过程</p>
              </div>
            </label>
          </div>
        </div>

        <!-- Diagnosis Button -->
        <div class="mt-6 text-center">
          <button
            id="diagnoseBtn"
            disabled
            class="px-8 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white font-semibold rounded-lg hover:from-blue-700 hover:to-purple-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed shadow-lg"
          >
            <i class="fas fa-stethoscope mr-2"></i> 开始智能诊断
          </button>
        </div>
      </div>

      <!-- Loading State -->
      <div id="loadingState" class="hidden">
        <div class="bg-blue-50 rounded-lg p-8 text-center">
          <div class="loader mx-auto mb-4"></div>
          <h3 class="text-lg font-semibold text-blue-800 mb-2">正在进行智能分析...</h3>
          <p class="text-blue-600 mb-4">请耐心等待，AI正在为您生成详细报告</p>

          <!-- Progress Bar -->
          <div class="w-full bg-gray-200 rounded-full h-2 mb-4">
            <div id="progressBar" class="bg-blue-600 h-2 rounded-full progress-bar" style="width: 0%"></div>
          </div>

          <div id="progressSteps" class="text-sm text-blue-700 space-y-1">
            <div class="step"><i class="fas fa-check-circle mr-1"></i> 图像上传完成</div>
            <div class="step opacity-50"><i class="fas fa-circle-notch fa-spin mr-1"></i> DR分级分析中...</div>
            <div class="step opacity-50"><i class="fas fa-circle-notch fa-spin mr-1"></i> 病灶识别中...</div>
            <div class="step opacity-50"><i class="fas fa-circle-notch fa-spin mr-1"></i> 知识检索中...</div>
            <div class="step opacity-50"><i class="fas fa-circle-notch fa-spin mr-1"></i> 生成诊断报告...</div>
          </div>
        </div>
      </div>

      <!-- Results Section -->
      <div id="resultsSection" class="hidden">
        <div class="mb-6">
          <h2 class="text-2xl font-bold text-gray-800 mb-2">
            <i class="fas fa-clipboard-list mr-2"></i> 诊断报告
          </h2>
          <p class="text-gray-600">AI分析结果 - 生成时间: <span id="reportTime"></span></p>
        </div>

        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
          <div class="result-card bg-white rounded-lg shadow-md p-6 border-l-4 border-blue-500">
            <div class="flex items-center justify-between mb-2">
              <h3 class="font-semibold text-gray-800">DR分级</h3>
              <i class="fas fa-eye text-blue-500"></i>
            </div>
            <div id="drGrade" class="text-2xl font-bold mb-1"></div>
            <div id="confidence" class="text-sm text-gray-600"></div>
          </div>

          <div class="result-card bg-white rounded-lg shadow-md p-6 border-l-4 border-green-500">
            <div class="flex items-center justify-between mb-2">
              <h3 class="font-semibold text-gray-800">风险评估</h3>
              <i class="fas fa-shield-alt text-green-500"></i>
            </div>
            <div id="riskLevel" class="text-2xl font-bold mb-1"></div>
            <div id="riskDesc" class="text-sm text-gray-600"></div>
          </div>

          <div class="result-card bg-white rounded-lg shadow-md p-6 border-l-4 border-purple-500">
            <div class="flex items-center justify-between mb-2">
              <h3 class="font-semibold text-gray-800">诊断建议</h3>
              <i class="fas fa-user-md text-purple-500"></i>
            </div>
            <div id="urgency" class="text-2xl font-bold mb-1"></div>
            <div id="urgencyDesc" class="text-sm text-gray-600"></div>
          </div>
        </div>

        <!-- Detailed Analysis -->
        <div class="space-y-6">
          <!-- Lesion Description -->
          <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <div class="p-4 bg-gray-50 border-b">
              <h3 class="font-semibold text-gray-800">
                <i class="fas fa-search mr-1"></i> 病灶描述
              </h3>
            </div>
            <div class="p-4">
              <pre id="lesionDesc" class="text-sm text-gray-700 whitespace-pre-wrap"></pre>
            </div>
          </div>

          <!-- CoT Reasoning -->
          <div id="cotSection" class="bg-white rounded-lg shadow-md overflow-hidden">
            <div class="p-4 bg-gray-50 border-b">
              <h3 class="font-semibold text-gray-800">
                <i class="fas fa-brain mr-1"></i> AI推理过程
              </h3>
            </div>
            <div class="p-4">
              <pre id="cotReasoning" class="text-sm text-gray-700 whitespace-pre-wrap"></pre>
            </div>
          </div>

          <!-- Retrieved Knowledge -->
          <div id="knowledgeSection" class="bg-white rounded-lg shadow-md overflow-hidden">
            <div class="p-4 bg-gray-50 border-b">
              <h3 class="font-semibold text-gray-800">
                <i class="fas fa-book-medical mr-1"></i> 医学知识参考
              </h3>
            </div>
            <div class="p-4">
              <ul id="retrievedKnowledge" class="space-y-2"></ul>
            </div>
          </div>

          <!-- Recommendations -->
          <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <div class="p-4 bg-gray-50 border-b">
              <h3 class="font-semibold text-gray-800">
                <i class="fas fa-clipboard-check mr-1"></i> 治疗建议
              </h3>
            </div>
            <div class="p-4">
              <ul id="recommendations" class="space-y-2"></ul>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="mt-8 flex flex-wrap gap-4">
          <button id="downloadReportBtn" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
            <i class="fas fa-download mr-2"></i> 下载报告
          </button>
          <button id="shareReportBtn" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
            <i class="fas fa-share-alt mr-2"></i> 分享报告
          </button>
          <button id="newDiagnosisBtn" class="px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
            <i class="fas fa-plus mr-2"></i> 新诊断
          </button>
        </div>
      </div>

      <!-- Logs Section -->
      <div id="logsSection" class="hidden mt-8">
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
          <div class="p-4 bg-gray-50 border-b flex justify-between items-center">
            <h3 class="font-semibold text-gray-800">
              <i class="fas fa-file-alt mr-1"></i> 系统日志
            </h3>
            <button id="closeLogsBtn" class="text-gray-500 hover:text-gray-700">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="p-4">
            <div id="logsContainer" class="bg-gray-900 text-green-400 p-4 rounded text-xs h-64 overflow-y-auto font-mono whitespace-pre-wrap"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="mt-8 text-center text-white/70 text-sm">
      <p>&copy; 2024 多模态智能诊断系统. 仅供科研和教育使用.</p>
      <p class="mt-1">
        <i class="fas fa-info-circle mr-1"></i>
        本系统不能替代专业医师诊断，仅供参考
      </p>
    </footer>
  </div>

  <script>
    // Global variables
    let currentFile = null;
    let diagnosisData = null;

    // DOM Elements
    const elements = {
      apiUrl: document.getElementById('apiUrl'),
      saveApiBtn: document.getElementById('saveApiBtn'),
      checkHealthBtn: document.getElementById('checkHealthBtn'),
      reloadKBBtn: document.getElementById('reloadKBBtn'),
      viewLogsBtn: document.getElementById('viewLogsBtn'),
      healthStatus: document.getElementById('healthStatus'),
      healthIndicator: document.getElementById('healthIndicator'),
      modelStatus: document.getElementById('modelStatus'),
      statusDR: document.getElementById('statusDR'),
      statusQwen: document.getElementById('statusQwen'),
      statusR1: document.getElementById('statusR1'),
      statusRAG: document.getElementById('statusRAG'),
      imageInput: document.getElementById('imageInput'),
      selectFileBtn: document.getElementById('selectFileBtn'),
      dropZone: document.getElementById('dropZone'),
      imagePreview: document.getElementById('imagePreview'),
      previewImg: document.getElementById('previewImg'),
      imageInfo: document.getElementById('imageInfo'),
      enableRag: document.getElementById('enableRag'),
      enableCot: document.getElementById('enableCot'),
      diagnoseBtn: document.getElementById('diagnoseBtn'),
      loadingState: document.getElementById('loadingState'),
      progressBar: document.getElementById('progressBar'),
      progressSteps: document.getElementById('progressSteps'),
      resultsSection: document.getElementById('resultsSection'),
      logsSection: document.getElementById('logsSection'),
      logsContainer: document.getElementById('logsContainer'),
      closeLogsBtn: document.getElementById('closeLogsBtn')
    };

    // Initialize
    function init() {
      loadSavedApiUrl();
      setupEventListeners();
      checkApiHealth();
    }

    // Load saved API URL
    function loadSavedApiUrl() {
      const savedUrl = localStorage.getItem('api_url') || 'http://localhost:8000';
      elements.apiUrl.value = savedUrl;
    }

    // Setup event listeners
    function setupEventListeners() {
      // API Configuration
      elements.saveApiBtn.addEventListener('click', saveApiUrl);
      elements.checkHealthBtn.addEventListener('click', checkApiHealth);
      elements.reloadKBBtn.addEventListener('click', reloadKnowledgeBase);
      elements.viewLogsBtn.addEventListener('click', toggleLogs);
      elements.closeLogsBtn.addEventListener('click', toggleLogs);

      // File Upload
      elements.selectFileBtn.addEventListener('click', () => elements.imageInput.click());
      elements.imageInput.addEventListener('change', handleFileSelect);
      elements.diagnoseBtn.addEventListener('click', startDiagnosis);

      // Drag and Drop
      elements.dropZone.addEventListener('click', () => elements.imageInput.click());
      elements.dropZone.addEventListener('dragover', handleDragOver);
      elements.dropZone.addEventListener('dragleave', handleDragLeave);
      elements.dropZone.addEventListener('drop', handleDrop);

      // Action buttons
      document.getElementById('downloadReportBtn').addEventListener('click', downloadReport);
      document.getElementById('shareReportBtn').addEventListener('click', shareReport);
      document.getElementById('newDiagnosisBtn').addEventListener('click', newDiagnosis);
    }

    // API URL Management
    function saveApiUrl() {
      const url = elements.apiUrl.value.trim();
      if (!url) {
        showNotification('请输入有效的API地址', 'error');
        return;
      }
      localStorage.setItem('api_url', url);
      showNotification('API地址已保存', 'success');
      checkApiHealth();
    }

    // Health Check
    async function checkApiHealth() {
      const apiUrl = elements.apiUrl.value.trim().replace(/\/$/, '');

      elements.healthStatus.textContent = '检查中...';
      elements.healthIndicator.className = 'w-3 h-3 bg-yellow-400 rounded-full mr-2 status-online';

      try {
        const response = await fetch(`${apiUrl}/api/health`);
        if (!response.ok) throw new Error('健康检查失败');

        const data = await response.json();
        elements.healthStatus.textContent = '服务正常';
        elements.healthIndicator.className = 'w-3 h-3 bg-green-400 rounded-full mr-2 status-online';

        // Show model status
        elements.modelStatus.classList.remove('hidden');
        updateModelStatus(data.models);

      } catch (error) {
        console.error('Health check failed:', error);
        elements.healthStatus.textContent = '服务不可用';
        elements.healthIndicator.className = 'w-3 h-3 bg-red-400 rounded-full mr-2';
        elements.modelStatus.classList.add('hidden');
        showNotification('无法连接到服务器', 'error');
      }
    }

    // Update model status display
    function updateModelStatus(models) {
      const modelElements = {
        dr_grading: elements.statusDR,
        qwen_vl: elements.statusQwen,
        r1_7b: elements.statusR1,
        rag: elements.statusRAG
      };

      Object.entries(modelElements).forEach(([model, element]) => {
        const isLoaded = models[model];
        element.textContent = isLoaded ? '已加载' : '未加载';
        element.className = `px-2 py-1 text-xs rounded-full ${
          isLoaded ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
        }`;
      });
    }

    // Knowledge Base Management
    async function reloadKnowledgeBase() {
      const apiUrl = elements.apiUrl.value.trim().replace(/\/$/, '');

      try {
        const response = await fetch(`${apiUrl}/api/knowledge/update`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify([])
        });

        if (!response.ok) throw new Error('知识库更新失败');

        showNotification('知识库更新成功', 'success');
        setTimeout(checkApiHealth, 1000);
      } catch (error) {
        console.error('KB reload failed:', error);
        showNotification('知识库更新失败', 'error');
      }
    }

    // File Handling
    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (file) {
        processFile(file);
      }
    }

    function handleDragOver(event) {
      event.preventDefault();
      elements.dropZone.classList.add('drag-active');
    }

    function handleDragLeave(event) {
      event.preventDefault();
      elements.dropZone.classList.remove('drag-active');
    }

    function handleDrop(event) {
      event.preventDefault();
      elements.dropZone.classList.remove('drag-active');

      const files = event.dataTransfer.files;
      if (files.length > 0) {
        processFile(files[0]);
      }
    }

    function processFile(file) {
      // Validate file
      if (!file.type.startsWith('image/')) {
        showNotification('请选择有效的图像文件', 'error');
        return;
      }

      if (file.size > 10 * 1024 * 1024) {
        showNotification('文件大小不能超过10MB', 'error');
        return;
      }

      currentFile = file;
      displayImagePreview(file);
      elements.diagnoseBtn.disabled = false;
    }

    function displayImagePreview(file) {
      const reader = new FileReader();

      reader.onload = function(event) {
        elements.previewImg.src = event.target.result;
        elements.imageInfo.textContent = `
          文件名: ${file.name} |
          大小: ${(file.size / 1024 / 1024).toFixed(2)} MB |
          类型: ${file.type}
        `;
        elements.imagePreview.classList.remove('hidden');
      };

      reader.readAsDataURL(file);
    }

    // Diagnosis
    async function startDiagnosis() {
      if (!currentFile) {
        showNotification('请先选择图像文件', 'error');
        return;
      }

      const apiUrl = elements.apiUrl.value.trim().replace(/\/$/, '');
      const formData = new FormData();

      formData.append('file', currentFile);
      formData.append('enable_rag', elements.enableRag.checked);
      formData.append('enable_cot', elements.enableCot.checked);

      // Show loading state
      elements.loadingState.classList.remove('hidden');
      elements.resultsSection.classList.add('hidden');
      elements.diagnoseBtn.disabled = true;

      // Simulate progress
      await simulateProgress();

      try {
        const response = await fetch(`${apiUrl}/api/diagnose`, {
          method: 'POST',
          body: formData
        });

        if (!response.ok) throw new Error('诊断请求失败');

        const data = await response.json();
        diagnosisData = data;

        displayResults(data);
        elements.loadingState.classList.add('hidden');
        elements.resultsSection.classList.remove('hidden');

      } catch (error) {
        console.error('Diagnosis failed:', error);
        showNotification('诊断失败: ' + error.message, 'error');
        elements.loadingState.classList.add('hidden');
      } finally {
        elements.diagnoseBtn.disabled = false;
      }
    }

    async function simulateProgress() {
      const steps = [
        { message: '图像上传完成', progress: 20 },
        { message: 'DR分级分析中...', progress: 35 },
        { message: '病灶识别中...', progress: 50 },
        { message: '知识检索中...', progress: 70 },
        { message: '生成诊断报告...', progress: 90 }
      ];

      for (let i = 0; i < steps.length; i++) {
        const step = steps[i];
        elements.progressBar.style.width = `${step.progress}%`;

        const stepElements = elements.progressSteps.querySelectorAll('.step');
        stepElements.forEach((el, index) => {
          if (index < i) {
            el.innerHTML = `<i class="fas fa-check-circle mr-1"></i> ${step.message}`;
            el.classList.remove('opacity-50');
          } else if (index === i) {
            el.innerHTML = `<i class="fas fa-circle-notch fa-spin mr-1"></i> ${step.message}`;
            el.classList.remove('opacity-50');
          }
        });

        await new Promise(resolve => setTimeout(resolve, 800));
      }

      elements.progressBar.style.width = '100%';
      const stepElements = elements.progressSteps.querySelectorAll('.step');
      stepElements[stepElements.length - 1].innerHTML = '<i class="fas fa-check-circle mr-1"></i> 诊断完成';
    }

    // Results Display
    function displayResults(data) {
      // Report timestamp
      document.getElementById('reportTime').textContent = new Date().toLocaleString('zh-CN');

      // DR Grade
      const gradeElement = document.getElementById('drGrade');
      gradeElement.textContent = `${data.dr_grade} (${data.dr_grade_desc})`;
      gradeElement.className = `text-2xl font-bold mb-1 severity-${data.dr_grade}`;

      // Confidence
      document.getElementById('confidence').textContent = `置信度: ${(data.confidence * 100).toFixed(1)}%`;

      // Risk Assessment
      const riskLevels = {
        0: { level: '低风险', desc: '无明显病变', class: 'text-green-600' },
        1: { level: '轻微风险', desc: '轻度非增殖期', class: 'text-yellow-600' },
        2: { level: '中度风险', desc: '中度非增殖期', class: 'text-orange-600' },
        3: { level: '高风险', desc: '重度非增殖期', class: 'text-red-600' },
        4: { level: '极高风险', desc: '增殖期视网膜病变', class: 'text-red-800' }
      };

      const risk = riskLevels[data.dr_grade] || riskLevels[0];
      document.getElementById('riskLevel').textContent = risk.level;
      document.getElementById('riskLevel').className = `text-2xl font-bold mb-1 ${risk.class}`;
      document.getElementById('riskDesc').textContent = risk.desc;

      // Urgency
      const urgencyLevels = {
        0: { level: '常规随访', desc: '12个月后复查' },
        1: { level: '定期观察', desc: '6-12个月后复查' },
        2: { level: '建议就诊', desc: '3-6个月后复查' },
        3: { level: '及时就医', desc: '1-3个月内复查' },
        4: { level: '立即就医', desc: '尽快寻求专科治疗' }
      };

      const urgency = urgencyLevels[data.dr_grade] || urgencyLevels[0];
      document.getElementById('urgency').textContent = urgency.level;
      document.getElementById('urgencyDesc').textContent = urgency.desc;

      // Lesion Description
      document.getElementById('lesionDesc').textContent = data.lesion_description;

      // CoT Reasoning
      if (elements.enableCot.checked && data.cot_reasoning) {
        document.getElementById('cotReasoning').textContent = data.cot_reasoning;
        document.getElementById('cotSection').classList.remove('hidden');
      } else {
        document.getElementById('cotSection').classList.add('hidden');
      }

      // Retrieved Knowledge
      if (elements.enableRag.checked && data.retrieved_knowledge) {
        const knowledgeList = document.getElementById('retrievedKnowledge');
        knowledgeList.innerHTML = data.retrieved_knowledge
          .map(knowledge => `<li class="flex items-start"><i class="fas fa-check-circle text-green-500 mr-2 mt-1"></i><span>${knowledge}</span></li>`)
          .join('');
        document.getElementById('knowledgeSection').classList.remove('hidden');
      } else {
        document.getElementById('knowledgeSection').classList.add('hidden');
      }

      // Recommendations
      const recommendationsList = document.getElementById('recommendations');
      recommendationsList.innerHTML = data.recommendations
        .map(rec => `<li class="flex items-start"><i class="fas fa-arrow-right text-blue-500 mr-2 mt-1"></i><span>${rec}</span></li>`)
        .join('');

      // Scroll to results
      elements.resultsSection.scrollIntoView({ behavior: 'smooth' });
    }

    // Logs Management
    async function fetchLogs() {
      const apiUrl = elements.apiUrl.value.trim().replace(/\/$/, '');

      try {
        const response = await fetch(`${apiUrl}/api/logs`);
        if (!response.ok) throw new Error('获取日志失败');

        const data = await response.json();
        elements.logsContainer.textContent = data.logs.join('\n');
        elements.logsSection.classList.remove('hidden');

      } catch (error) {
        console.error('Failed to fetch logs:', error);
        showNotification('无法获取系统日志', 'error');
      }
    }

    function toggleLogs() {
      if (elements.logsSection.classList.contains('hidden')) {
        fetchLogs();
      } else {
        elements.logsSection.classList.add('hidden');
      }
    }

    // Report Actions
    function downloadReport() {
      if (!diagnosisData) return;

      const report = generateTextReport(diagnosisData);
      const blob = new Blob([report], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = `诊断报告_${new Date().toISOString().split('T')[0]}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      showNotification('报告下载成功', 'success');
    }

    function generateTextReport(data) {
      return `
糖尿病视网膜病变AI诊断报告
=====================================
生成时间: ${new Date().toLocaleString('zh-CN')}

基本信息
--------
DR分级: ${data.dr_grade} (${data.dr_grade_desc})
置信度: ${(data.confidence * 100).toFixed(1)}%

病灶描述
--------
${data.lesion_description}

${data.cot_reasoning ? `
AI推理过程
---------
${data.cot_reasoning}
` : ''}

${data.retrieved_knowledge && data.retrieved_knowledge.length > 0 ? `
医学知识参考
------------
${data.retrieved_knowledge.join('\n\n')}
` : ''}

治疗建议
--------
${data.recommendations.join('\n')}

免责声明
--------
本报告由AI系统生成，仅供参考，不能替代专业医师诊断。
请结合临床检查结果和医师建议进行综合判断。
      `.trim();
    }

    function shareReport() {
      if (!diagnosisData) return;

      const reportText = generateTextReport(diagnosisData);

      if (navigator.share) {
        navigator.share({
          title: '糖尿病视网膜病变诊断报告',
          text: reportText
        }).then(() => {
          showNotification('报告分享成功', 'success');
        }).catch(() => {
          copyToClipboard(reportText);
        });
      } else {
        copyToClipboard(reportText);
      }
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        showNotification('报告已复制到剪贴板', 'success');
      }).catch(() => {
        showNotification('复制失败，请手动复制', 'error');
      });
    }

    function newDiagnosis() {
      // Reset form
      currentFile = null;
      diagnosisData = null;
      elements.imageInput.value = '';
      elements.imagePreview.classList.add('hidden');
      elements.resultsSection.classList.add('hidden');
      elements.loadingState.classList.add('hidden');
      elements.diagnoseBtn.disabled = true;
      elements.progressBar.style.width = '0%';

      // Reset progress steps
      const stepElements = elements.progressSteps.querySelectorAll('.step');
      stepElements.forEach((el, index) => {
        if (index === 0) {
          el.innerHTML = '<i class="fas fa-check-circle mr-1"></i> 图像上传完成';
          el.classList.remove('opacity-50');
        } else {
          el.innerHTML = `<i class="fas fa-circle-notch fa-spin mr-1"></i> ${el.textContent.replace(/.*?\s/, '')}`;
          el.classList.add('opacity-50');
        }
      });

      // Scroll to top
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Utility Functions
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      const colors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        warning: 'bg-yellow-500',
        info: 'bg-blue-500'
      };

      notification.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 fade-in`;
      notification.textContent = message;

      document.body.appendChild(notification);

      setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => {
          document.body.removeChild(notification);
        }, 300);
      }, 3000);
    }

    // Initialize app
    init();
  </script>
</body>
</html>