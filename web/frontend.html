<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>多模态智能眼底诊断系统 V3.0</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <!-- Google Fonts: Inter & JetBrains Mono -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
            mono: ['JetBrains Mono', 'monospace'],
          },
          colors: {
            primary: '#3b82f6',
            secondary: '#6366f1',
            dark: '#0f172a',
            surface: '#1e293b',
          },
          animation: {
            'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            'float': 'float 6s ease-in-out infinite',
          },
          keyframes: {
            float: {
              '0%, 100%': { transform: 'translateY(0)' },
              '50%': { transform: 'translateY(-10px)' },
            }
          }
        }
      }
    }
  </script>

  <style>
    body {
      background: radial-gradient(circle at top center, #1e293b 0%, #020617 100%);
      color: #e2e8f0;
    }
    
    /* Glassmorphism */
    .glass-panel {
      background: rgba(30, 41, 59, 0.7);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }

    .glass-card {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #64748b; }

    /* Animations */
    .fade-in-up { animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1); }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .drag-active {
      border-color: #3b82f6 !important;
      background-color: rgba(59, 130, 246, 0.1) !important;
      transform: scale(1.01);
    }

    /* Loader */
    .medical-loader {
      width: 64px;
      height: 64px;
      position: relative;
    }
    .medical-loader::before, .medical-loader::after {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      border-radius: 50%;
      border: 4px solid transparent;
      border-top-color: #3b82f6;
    }
    .medical-loader::before { animation: spin 1.5s linear infinite; }
    .medical-loader::after { 
      border-top-color: #6366f1; 
      animation: spin 1s linear infinite reverse; 
      margin: 8px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body class="min-h-screen flex flex-col antialiased font-sans selection:bg-blue-500 selection:text-white overflow-x-hidden">

  <!-- Background Effects -->
  <div class="fixed inset-0 pointer-events-none overflow-hidden">
    <div class="absolute top-[-10%] left-[-10%] w-[40%] h-[40%] bg-blue-500/10 rounded-full blur-[120px] animate-float"></div>
    <div class="absolute bottom-[-10%] right-[-10%] w-[40%] h-[40%] bg-purple-500/10 rounded-full blur-[120px] animate-float" style="animation-delay: -3s;"></div>
  </div>

  <!-- Navbar -->
  <nav class="w-full z-50 px-6 py-4 flex justify-between items-center border-b border-white/5 bg-slate-900/50 backdrop-blur-md sticky top-0">
    <div class="flex items-center gap-4">
      <div class="bg-gradient-to-br from-blue-600 to-indigo-600 w-10 h-10 rounded-xl flex items-center justify-center shadow-lg shadow-blue-500/20 text-white">
        <i class="fas fa-eye text-lg"></i>
      </div>
      <div>
        <h1 class="text-white text-lg font-bold tracking-tight">RetinaAI <span class="text-blue-400 font-light">Diagnosis</span></h1>
        <div class="flex items-center gap-2">
            <span id="statusIndicator" class="w-2 h-2 rounded-full bg-yellow-500 animate-pulse"></span>
            <p id="statusText" class="text-yellow-400 text-xs font-mono">Connecting...</p>
        </div>
      </div>
    </div>
    <div class="flex items-center gap-3">
        <button id="metricsBtn" class="text-slate-400 hover:text-white transition-colors p-2 rounded-lg hover:bg-white/5" title="系统监控">
            <i class="fas fa-chart-line"></i>
        </button>
        <button id="openSettingsBtn" class="text-slate-400 hover:text-white transition-colors p-2 rounded-lg hover:bg-white/5" title="设置">
            <i class="fas fa-cog"></i>
        </button>
    </div>
  </nav>

  <!-- Main Container -->
  <main class="flex-1 container mx-auto px-4 py-8 max-w-6xl relative z-10">
    
    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 z-[60] hidden flex items-center justify-center">
      <div class="absolute inset-0 bg-black/80 backdrop-blur-sm transition-opacity" id="closeSettingsBackdrop"></div>
      <div class="relative w-full max-w-md glass-panel rounded-2xl p-6 fade-in-up border border-slate-700">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-lg font-bold text-white">系统配置</h3>
          <button id="closeSettingsBtn" class="text-slate-400 hover:text-white"><i class="fas fa-times"></i></button>
        </div>
        
        <div class="space-y-6">
          <div>
            <label class="block text-xs font-medium text-slate-400 mb-2 uppercase tracking-wider">API 服务器地址</label>
            <div class="flex gap-2">
              <input type="url" id="apiUrl" class="flex-1 px-4 py-2 bg-slate-900/50 border border-slate-700 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm text-white placeholder-slate-600" placeholder="http://localhost:8000">
              <button id="saveApiBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-500 text-sm font-medium transition-colors">保存</button>
            </div>
          </div>

          <div class="glass-card p-4 rounded-xl">
            <div class="flex justify-between items-center mb-4">
              <span class="text-sm font-medium text-slate-300">知识库管理</span>
            </div>
            <button id="reloadKBBtn" class="w-full flex items-center justify-center gap-2 py-2 px-3 bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded-lg text-sm text-slate-300 transition-all">
              <i class="fas fa-sync-alt"></i> 重新加载 RAG 知识库
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Metrics Modal -->
    <div id="metricsModal" class="fixed inset-0 z-[60] hidden flex items-center justify-center">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" id="closeMetricsBackdrop"></div>
        <div class="relative w-full max-w-2xl glass-panel rounded-2xl p-6 fade-in-up border border-slate-700">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold text-white flex items-center gap-2">
                    <i class="fas fa-server text-blue-500"></i> 系统实时监控
                </h3>
                <button id="closeMetricsBtn" class="text-slate-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div id="metricsContent" class="grid grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Metrics will be injected here -->
                <div class="col-span-full flex flex-col items-center justify-center py-12 text-slate-500">
                    <i class="fas fa-circle-notch fa-spin text-3xl mb-4 text-blue-500"></i>
                    <p class="font-mono text-sm">正在获取系统指标...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Workspace -->
    <div class="glass-panel rounded-3xl overflow-hidden min-h-[600px] relative">
      
      <!-- Upload Section -->
      <div id="uploadSection" class="p-8 md:p-16 flex flex-col items-center justify-center min-h-[600px] transition-all duration-500">
        
        <div class="text-center mb-10">
            <h2 class="text-3xl md:text-4xl font-bold text-white mb-4">智能眼底病变诊断</h2>
            <p class="text-slate-400 max-w-lg mx-auto">上传眼底图像，利用 ResNet152、Qwen-VL 和 DeepSeek-R1 进行多模态分析与诊断。</p>
        </div>

        <!-- Settings Toggles -->
        <div class="flex flex-wrap justify-center gap-6 mb-10">
            <label class="flex items-center cursor-pointer group select-none">
              <div class="relative">
                <input type="checkbox" id="enableRag" checked class="peer sr-only">
                <div class="w-11 h-6 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
              </div>
              <span class="ml-3 text-sm font-medium text-slate-400 group-hover:text-blue-400 transition-colors">RAG 知识增强</span>
            </label>

            <label class="flex items-center cursor-pointer group select-none">
              <div class="relative">
                <input type="checkbox" id="enableCot" checked class="peer sr-only">
                <div class="w-11 h-6 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
              </div>
              <span class="ml-3 text-sm font-medium text-slate-400 group-hover:text-purple-400 transition-colors">CoT 思维链</span>
            </label>
        </div>

        <!-- Drop Zone -->
        <div id="dropZone" class="w-full max-w-xl relative group border-2 border-dashed border-slate-600 rounded-2xl p-12 text-center transition-all duration-300 hover:border-blue-500 hover:bg-slate-800/50 cursor-pointer">
          <input type="file" id="imageInput" accept="image/*" class="hidden">
          
          <!-- Placeholder -->
          <div id="uploadPlaceholder" class="transition-opacity duration-300">
            <div class="w-20 h-20 bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-6 group-hover:scale-110 transition-transform duration-300 border border-slate-700 group-hover:border-blue-500/50">
              <i class="fas fa-cloud-upload-alt text-3xl text-blue-500"></i>
            </div>
            <h3 class="text-xl font-bold text-white mb-2">点击或拖拽上传图像</h3>
            <p class="text-slate-500 text-sm">支持 JPG, PNG 格式 (Max 10MB)</p>
          </div>

          <!-- Preview -->
          <div id="imagePreview" class="hidden">
            <div class="relative rounded-xl overflow-hidden shadow-2xl border border-slate-700 group-hover:border-blue-500/50 transition-colors">
               <img id="previewImg" class="w-full object-cover max-h-[400px]" alt="预览">
               <div class="absolute bottom-0 left-0 right-0 bg-black/70 backdrop-blur-sm p-3 text-white text-xs font-mono flex justify-between items-center" id="imageInfo"></div>
               <button id="removeImgBtn" class="absolute top-3 right-3 bg-black/50 hover:bg-red-500/80 text-white rounded-full w-8 h-8 flex items-center justify-center transition-all backdrop-blur-sm">
                 <i class="fas fa-times"></i>
               </button>
            </div>
          </div>
        </div>

        <!-- Action Button -->
        <div class="mt-10">
          <button id="diagnoseBtn" disabled class="px-12 py-4 bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-bold rounded-xl shadow-lg shadow-blue-500/20 hover:shadow-blue-500/40 hover:-translate-y-1 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none transition-all duration-300 text-lg flex items-center gap-3">
            <i class="fas fa-wand-magic-sparkles"></i>
            开始智能诊断
          </button>
        </div>
      </div>

      <!-- Loading Screen -->
      <div id="loadingState" class="hidden absolute inset-0 bg-slate-900/90 backdrop-blur-md z-10 flex flex-col items-center justify-center fade-in-up">
        <div class="medical-loader mb-8"></div>
        <h3 class="text-2xl font-bold text-white mb-2">正在进行多模态分析</h3>
        <p class="text-slate-400 mb-10 font-mono text-sm" id="loadingText">AI 正在整合视觉特征与医学知识库...</p>
        
        <div class="w-80 h-1.5 bg-slate-800 rounded-full overflow-hidden">
          <div id="progressBar" class="h-full bg-gradient-to-r from-blue-500 to-purple-500 rounded-full transition-all duration-500 relative" style="width: 0%">
            <div class="absolute right-0 top-0 bottom-0 w-20 bg-gradient-to-r from-transparent to-white/30"></div>
          </div>
        </div>
        <div id="progressSteps" class="mt-4 text-xs font-mono text-blue-400 h-6">初始化...</div>
      </div>

      <!-- Results Section -->
      <div id="resultsSection" class="hidden bg-slate-900/50 min-h-[600px] fade-in-up">
        
        <!-- Header -->
        <div class="p-8 lg:p-10 border-b border-white/5 bg-slate-800/30">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6 mb-10">
                <div>
                    <div class="flex items-center gap-3 mb-2">
                        <div class="w-10 h-10 rounded-full bg-green-500/20 flex items-center justify-center text-green-400">
                            <i class="fas fa-clipboard-check text-xl"></i>
                        </div>
                        <h2 class="text-3xl font-bold text-white tracking-tight">诊断报告</h2>
                    </div>
                    <p class="text-sm font-mono text-slate-500 pl-[3.25rem]">ID: <span id="traceId" class="select-all text-slate-400 hover:text-white transition-colors cursor-pointer" title="点击复制">--</span></p>
                </div>
                <div class="flex gap-3">
                    <button id="newDiagnosisBtn" class="px-5 py-2.5 bg-slate-800 hover:bg-slate-700 border border-slate-700 text-slate-300 rounded-xl text-sm font-medium transition-all hover:shadow-lg hover:border-slate-600 flex items-center gap-2">
                        <i class="fas fa-redo"></i> 重置诊断
                    </button>
                    <button id="downloadReportBtn" class="px-5 py-2.5 bg-blue-600/10 hover:bg-blue-600/20 border border-blue-500/30 text-blue-400 rounded-xl text-sm font-medium transition-all hover:shadow-lg hover:border-blue-500/50 flex items-center gap-2">
                        <i class="fas fa-download"></i> 导出报告
                    </button>
                </div>
            </div>

            <!-- Metrics Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- DR Grade -->
                <div class="glass-card p-6 rounded-2xl relative overflow-hidden group hover:bg-white/5 transition-colors border border-white/5">
                    <div class="absolute top-0 right-0 p-6 opacity-5 group-hover:opacity-10 transition-opacity transform group-hover:scale-110 duration-500">
                        <i class="fas fa-microscope text-7xl text-white"></i>
                    </div>
                    <div class="relative z-10">
                        <div class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3">DR 分级结果</div>
                        <div id="drGrade" class="text-4xl font-bold text-white mb-2 tracking-tight">--</div>
                        <div class="flex items-center gap-2 mt-4">
                            <div id="confidence" class="text-xs font-mono px-2.5 py-1 rounded-md bg-white/5 text-slate-300 border border-white/10 backdrop-blur-sm">
                                置信度: --%
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Risk Level -->
                <div class="glass-card p-6 rounded-2xl relative overflow-hidden group hover:bg-white/5 transition-colors border border-white/5">
                    <div class="absolute top-0 right-0 p-6 opacity-5 group-hover:opacity-10 transition-opacity transform group-hover:scale-110 duration-500">
                        <i class="fas fa-heart-pulse text-7xl text-white"></i>
                    </div>
                    <div class="relative z-10">
                        <div class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3">风险评估</div>
                        <div id="riskLevel" class="text-3xl font-bold text-white mb-2 tracking-tight">--</div>
                        <div id="riskDesc" class="text-sm text-slate-400 font-medium">--</div>
                    </div>
                </div>

                <!-- Processing Time -->
                <div class="glass-card p-6 rounded-2xl relative overflow-hidden group hover:bg-white/5 transition-colors border border-white/5">
                    <div class="absolute top-0 right-0 p-6 opacity-5 group-hover:opacity-10 transition-opacity transform group-hover:scale-110 duration-500">
                        <i class="fas fa-clock text-7xl text-white"></i>
                    </div>
                    <div class="relative z-10">
                        <div class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3">系统耗时</div>
                        <div id="processTime" class="text-4xl font-mono font-bold text-white mb-2 tracking-tight">--s</div>
                        <div class="text-xs text-slate-500">端到端处理时间</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Analysis -->
        <div class="p-8 lg:p-10 grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <!-- Left: Vision & Recommendations -->
            <div class="space-y-8">
                <!-- Visual Features -->
                <div class="glass-card rounded-2xl p-1 border border-white/5">
                    <div class="bg-slate-900/40 rounded-xl p-6">
                        <h3 class="font-bold text-white mb-6 flex items-center gap-3 text-lg">
                            <div class="w-8 h-8 rounded-lg bg-blue-500/20 flex items-center justify-center text-blue-400">
                                <i class="fas fa-eye"></i>
                            </div>
                            病灶视觉特征 (Qwen-VL)
                        </h3>
                        <div class="bg-slate-950/50 rounded-xl p-5 border border-slate-800/50 shadow-inner">
                            <p id="lesionDesc" class="text-slate-300 leading-relaxed text-sm whitespace-pre-wrap font-mono tracking-wide">--</p>
                        </div>
                    </div>
                </div>

                <!-- Traceability -->
                <div id="traceSection" class="glass-card rounded-2xl p-1 border border-white/5 hidden">
                    <div class="bg-slate-900/40 rounded-xl p-6">
                        <h3 class="font-bold text-white mb-6 flex items-center gap-3 text-lg">
                            <div class="w-8 h-8 rounded-lg bg-indigo-500/20 flex items-center justify-center text-indigo-400">
                                <i class="fas fa-link"></i>
                            </div>
                            知识溯源 (RAG)
                        </h3>
                        <div class="bg-indigo-950/30 rounded-xl p-5 border border-indigo-500/20 relative overflow-hidden">
                            <div class="absolute top-0 right-0 p-4 opacity-5">
                                <i class="fas fa-book text-6xl text-indigo-400"></i>
                            </div>
                            <p id="traceability" class="text-sm text-indigo-200/80 italic leading-relaxed relative z-10">--</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right: Reasoning & Traceability -->
            <div class="space-y-8">
                <!-- CoT -->
                <div id="cotSection" class="glass-card rounded-2xl p-1 border border-white/5 hidden">
                    <div class="bg-slate-900/40 rounded-xl p-6">
                        <h3 class="font-bold text-white mb-6 flex items-center gap-3 text-lg">
                            <div class="w-8 h-8 rounded-lg bg-purple-500/20 flex items-center justify-center text-purple-400">
                                <i class="fas fa-brain"></i>
                            </div>
                            AI 思维链推理 (DeepSeek-R1)
                        </h3>
                        <div class="bg-slate-950/80 rounded-xl p-5 overflow-hidden border border-slate-800/50 shadow-inner relative group">
                            <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button class="text-xs bg-slate-800 text-slate-400 px-2 py-1 rounded hover:text-white" onclick="navigator.clipboard.writeText(document.getElementById('cotReasoning').innerText)">复制</button>
                            </div>
                            <pre id="cotReasoning" class="text-xs text-green-400/90 font-mono whitespace-pre-wrap max-h-[400px] overflow-y-auto custom-scrollbar leading-relaxed p-1">--</pre>
                        </div>
                    </div>
                </div>

                <!-- Recommendations -->
                <div class="glass-card rounded-2xl p-1 border border-white/5">
                    <div class="bg-slate-900/40 rounded-xl p-6">
                         <h3 class="font-bold text-white mb-6 flex items-center gap-3 text-lg">
                            <div class="w-8 h-8 rounded-lg bg-emerald-500/20 flex items-center justify-center text-emerald-400">
                                <i class="fas fa-user-md"></i>
                            </div>
                            治疗建议
                        </h3>
                        <ul id="recommendations" class="space-y-4"></ul>
                    </div>
                </div>
            </div>
        </div>
      </div>

    </div>

    <!-- Footer -->
    <footer class="text-center py-8 border-t border-white/5 mt-8">
        <p class="text-slate-600 text-xs font-mono">
            © 2024 Multimodal Diagnosis System. Research Preview.<br>
            Powered by PyTorch, FastAPI, Qwen-VL & DeepSeek-R1.
        </p>
    </footer>

  </main>

  <!-- Toast Container -->
  <div id="toastContainer" class="fixed top-5 right-5 z-[100] flex flex-col gap-2"></div>

  <script>
    // --- Configuration ---
    const DEFAULT_API_URL = 'http://localhost:8000';
    let currentFile = null;
    let diagnosisData = null;
    let metricsRefreshInterval = null; // Global timer for metrics auto-refresh
    let isMetricsModalOpen = false;    // Track modal open state

    // --- DOM Elements ---
    const $ = (id) => document.getElementById(id);
    const els = {
        settingsModal: $('settingsModal'),
        metricsModal: $('metricsModal'),
        uploadSection: $('uploadSection'),
        resultsSection: $('resultsSection'),
        loadingState: $('loadingState'),
        dropZone: $('dropZone'),
        imageInput: $('imageInput'),
        previewImg: $('previewImg'),
        progressBar: $('progressBar'),
        progressSteps: $('progressSteps'),
        apiUrl: $('apiUrl'),
        metricsContent: $('metricsContent')
    };

    // --- Initialization ---
    function init() {
        els.apiUrl.value = localStorage.getItem('api_url') || DEFAULT_API_URL;
        setupEventListeners();
        
        // Initial system status check
        updateSystemStatus('checking');
        checkHealth();
        
        // Periodic health check every 10 seconds
        setInterval(checkHealth, 10000);
        
        // Pause metrics refresh when page is hidden, resume when visible
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && metricsRefreshInterval) {
                console.log('[Metrics] Page hidden, pausing refresh');
                clearInterval(metricsRefreshInterval);
                metricsRefreshInterval = null;
            } else if (!document.hidden && isMetricsModalOpen) {
                console.log('[Metrics] Page visible, resuming refresh');
                if (!metricsRefreshInterval) {
                    fetchMetrics();
                    metricsRefreshInterval = setInterval(() => {
                        if (isMetricsModalOpen && !els.metricsModal.classList.contains('hidden')) {
                            fetchMetrics();
                        }
                    }, 2000);
                }
            }
        });
        
        // Initial health check
        checkHealth();
    }

    function getApiUrl() {
        return els.apiUrl.value.replace(/\/$/, '');
    }

    // --- Event Listeners ---
    function setupEventListeners() {
        // Modals
        $('openSettingsBtn').onclick = () => els.settingsModal.classList.remove('hidden');
        $('closeSettingsBtn').onclick = () => els.settingsModal.classList.add('hidden');
        $('closeSettingsBackdrop').onclick = () => els.settingsModal.classList.add('hidden');

        $('metricsBtn').onclick = () => {
            // Clear any existing interval first to prevent timer leaks
            if (metricsRefreshInterval) {
                clearInterval(metricsRefreshInterval);
                metricsRefreshInterval = null;
            }

            isMetricsModalOpen = true;
            els.metricsModal.classList.remove('hidden');
            fetchMetrics();
            
            // Start auto-refresh every 2 seconds with enhanced protection
            metricsRefreshInterval = setInterval(() => {
                // Double check modal is still open before fetching
                if (isMetricsModalOpen && !els.metricsModal.classList.contains('hidden')) {
                    fetchMetrics();
                } else {
                    // Safety: clear interval if modal somehow closed
                    if (metricsRefreshInterval) {
                        clearInterval(metricsRefreshInterval);
                        metricsRefreshInterval = null;
                    }
                }
            }, 2000);
        };

        const closeMetricsModal = () => {
            isMetricsModalOpen = false;
            els.metricsModal.classList.add('hidden');
            
            // Stop auto-refresh when modal is closed
            if (metricsRefreshInterval) {
                clearInterval(metricsRefreshInterval);
                metricsRefreshInterval = null;
            }
        };

        $('closeMetricsBtn').onclick = closeMetricsModal;
        $('closeMetricsBackdrop').onclick = closeMetricsModal;


        // Settings
        $('saveApiBtn').onclick = () => {
            const url = els.apiUrl.value.trim();
            if(url) {
                localStorage.setItem('api_url', url);
                showToast('API 地址已保存', 'success');
                els.settingsModal.classList.add('hidden');
            }
        };
        $('reloadKBBtn').onclick = reloadKnowledgeBase;

        // Upload
        els.dropZone.onclick = (e) => {
            if(e.target.id !== 'removeImgBtn' && !e.target.closest('#removeImgBtn')) {
                els.imageInput.click();
            }
        };
        els.dropZone.ondragover = (e) => { e.preventDefault(); els.dropZone.classList.add('drag-active'); };
        els.dropZone.ondragleave = (e) => { e.preventDefault(); els.dropZone.classList.remove('drag-active'); };
        els.dropZone.ondrop = (e) => {
            e.preventDefault();
            els.dropZone.classList.remove('drag-active');
            if(e.dataTransfer.files.length) processFile(e.dataTransfer.files[0]);
        };
        els.imageInput.onchange = (e) => processFile(e.target.files[0]);
        $('removeImgBtn').onclick = (e) => {
            e.stopPropagation();
            resetUpload();
        };

        // Actions
        $('diagnoseBtn').onclick = startDiagnosis;
        $('newDiagnosisBtn').onclick = resetAll;
        $('downloadReportBtn').onclick = downloadReport;
    }

    // --- Core Logic ---
    async function checkHealth() {
        try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 3000); // 3秒超时
            
            const res = await fetch(`${getApiUrl()}/health`, {
                method: 'GET',
                signal: controller.signal
            });
            
            clearTimeout(timeoutId);
            
            if (res.ok) {
                updateSystemStatus('online');
            } else {
                updateSystemStatus('offline');
            }
        } catch(e) {
            console.warn('Health check failed', e);
            updateSystemStatus('offline');
        }
    }

    function updateSystemStatus(status) {
        const indicatorEl = document.getElementById('statusIndicator');
        const textEl = document.getElementById('statusText');
        
        if (!indicatorEl || !textEl) return; // Safety check
        
        if (status === 'online') {
            indicatorEl.className = 'w-2 h-2 rounded-full bg-green-500 animate-pulse';
            textEl.textContent = 'System Online';
            textEl.className = 'text-slate-400 text-xs font-mono';
        } else if (status === 'offline') {
            indicatorEl.className = 'w-2 h-2 rounded-full bg-red-500';
            textEl.textContent = 'System Offline';
            textEl.className = 'text-red-400 text-xs font-mono';
        } else { // 'checking'
            indicatorEl.className = 'w-2 h-2 rounded-full bg-yellow-500 animate-pulse';
            textEl.textContent = 'Connecting...';
            textEl.className = 'text-yellow-400 text-xs font-mono';
        }
    }

    async function fetchMetrics() {
        try {
            const res = await fetch(`${getApiUrl()}/metrics`);
            if(!res.ok) throw new Error('Failed');
            const data = await res.json();

            // Check if metrics already rendered
            const existingMetrics = els.metricsContent.querySelectorAll('[data-metric-key]');

            if (existingMetrics.length === 0) {
                // First time rendering - create full HTML structure
                const metricsHtml = Object.entries(data).map(([key, value]) => {
                    const icon = getMetricIcon(key);
                    const label = key.replace(/_/g, ' ');
                    return `
                    <div class="bg-slate-800/40 p-5 rounded-2xl border border-white/5 hover:bg-slate-800/60 transition-colors group">
                        <div class="flex justify-between items-start mb-2">
                            <div class="text-xs font-bold text-slate-500 uppercase tracking-wider">${label}</div>
                            <i class="fas ${icon} text-slate-600 group-hover:text-blue-500 transition-colors"></i>
                        </div>
                        <div class="text-2xl font-mono font-bold text-white group-hover:text-blue-400 transition-colors" data-metric-key="${key}">${formatMetric(value)}</div>
                    </div>
                    `;
                }).join('');
                els.metricsContent.innerHTML = metricsHtml;
            } else {
                // Update only the values, not the entire HTML
                Object.entries(data).forEach(([key, value]) => {
                    const valueEl = els.metricsContent.querySelector(`[data-metric-key="${key}"]`);
                    if (valueEl) {
                        valueEl.textContent = formatMetric(value);
                    }
                });
            }
        } catch(e) {
            console.warn('Metrics fetch failed:', e);
            // Don't update UI on temporary failures to avoid flashing
            // The interval will retry automatically
        }
    }

    function formatMetric(val) {
        if(typeof val === 'number') return val.toFixed(1);
        return val;
    }

    async function reloadKnowledgeBase() {
        try {
            const res = await fetch(`${getApiUrl()}/reload-knowledge-base`, {method: 'POST'});
            if(res.ok) showToast('知识库重载任务已启动', 'success');
            else throw new Error('Failed');
        } catch(e) {
            showToast('请求失败', 'error');
        }
    }

    function processFile(file) {
        if (!file || !file.type.startsWith('image/')) return showToast('请上传图片文件', 'error');
        if (file.size > 50 * 1024 * 1024) return showToast('图片过大 (>50MB)', 'error');

        currentFile = file;
        const reader = new FileReader();
        reader.onload = (e) => {
            els.previewImg.src = e.target.result;
            $('imageInfo').innerHTML = `<span>${file.name}</span><span>${(file.size/1024/1024).toFixed(2)} MB</span>`;
            
            $('uploadPlaceholder').classList.add('hidden');
            $('imagePreview').classList.remove('hidden');
            $('diagnoseBtn').disabled = false;
            els.dropZone.classList.add('border-blue-500', 'bg-slate-800/80');
        };
        reader.readAsDataURL(file);
    }

    function resetUpload() {
        currentFile = null;
        els.imageInput.value = '';
        $('uploadPlaceholder').classList.remove('hidden');
        $('imagePreview').classList.add('hidden');
        $('diagnoseBtn').disabled = true;
        els.dropZone.classList.remove('border-blue-500', 'bg-slate-800/80');
    }

    async function startDiagnosis() {
        if (!currentFile) return;

        // UI State
        $('diagnoseBtn').disabled = true;
        els.loadingState.classList.remove('hidden');
        els.uploadSection.classList.add('hidden');
        
        // Simulated Progress
        simulateProgress();

        try {
            const formData = new FormData();
            formData.append('file', currentFile);
            formData.append('enable_rag', $('enableRag').checked);
            formData.append('enable_cot', $('enableCot').checked);

            const res = await fetch(`${getApiUrl()}/diagnose`, {
                method: 'POST',
                body: formData
            });

            if (!res.ok) {
                const err = await res.json();
                throw new Error(err.detail || '诊断请求失败');
            }

            diagnosisData = await res.json();
            renderResults(diagnosisData);

        } catch (e) {
            console.error(e);
            showToast(e.message, 'error');
            // Reset UI on error
            els.loadingState.classList.add('hidden');
            els.uploadSection.classList.remove('hidden');
            $('diagnoseBtn').disabled = false;
        }
    }

    async function simulateProgress() {
        const steps = [
            { p: 10, t: '正在上传影像数据...' },
            { p: 30, t: 'ResNet152 正在进行 DR 分级...' },
            { p: 50, t: 'Qwen-VL 正在提取病灶特征...' },
            { p: 70, t: 'RAG 检索医学知识库...' },
            { p: 90, t: 'DeepSeek-R1 生成诊断报告...' }
        ];
        
        for(const step of steps) {
            if(diagnosisData) break; // Stop if done
            els.progressBar.style.width = step.p + '%';
            els.progressSteps.textContent = step.t;
            await new Promise(r => setTimeout(r, 800));
        }
    }

    function renderResults(data) {
        els.loadingState.classList.add('hidden');
        els.resultsSection.classList.remove('hidden');

        // Header Info
        $('traceId').textContent = data.trace_id;
        $('processTime').textContent = data.processing_time.toFixed(2) + 's';

        // 1. DR Grade
        const gradeEl = $('drGrade');
        // Display both numeric grade and description
        gradeEl.innerHTML = `\u003cspan class=\"text-2xl font-mono\"\u003e级别 ${data.dr_grade}\u003c/span\u003e\u003cbr\u003e${data.dr_grade_desc}`;
        gradeEl.className = `text-4xl font-bold mb-2 ${getGradeColor(data.dr_grade)}`;
        $('confidence').textContent = `置信度: ${(data.confidence * 100).toFixed(1)}%`;

        // 2. Risk Level
        $('riskLevel').textContent = getRiskLevel(data.dr_grade);
        $('riskLevel').className = `text-3xl font-bold mb-2 ${getRiskColor(data.dr_grade)}`;
        $('riskDesc').textContent = getRiskDesc(data.dr_grade);

        // 3. Lesion Description
        $('lesionDesc').textContent = data.lesion_description;

        // 4. Recommendations
        const recs = data.structured_report.recommendations || [];
        $('recommendations').innerHTML = recs.map(r => 
            `<li class="flex items-start gap-4 bg-slate-950/30 p-4 rounded-xl border border-slate-800/50 hover:border-emerald-500/30 transition-colors group">
                <div class="mt-0.5 w-5 h-5 rounded-full bg-emerald-500/10 flex items-center justify-center flex-shrink-0 group-hover:bg-emerald-500/20 transition-colors">
                    <i class="fas fa-check text-xs text-emerald-500"></i>
                </div>
                <span class="text-slate-300 text-sm leading-relaxed">${r}</span>
            </li>`
        ).join('');

        // 5. CoT Reasoning
        if (data.structured_report.cot_reasoning) {
            $('cotSection').classList.remove('hidden');
            $('cotReasoning').textContent = data.structured_report.cot_reasoning;
        } else {
            $('cotSection').classList.add('hidden');
        }

        // 6. Traceability
        if (data.structured_report.traceability) {
            $('traceSection').classList.remove('hidden');
            $('traceability').textContent = data.structured_report.traceability;
        } else {
            $('traceSection').classList.add('hidden');
        }

        // Scroll to top
        window.scrollTo({top: 0, behavior: 'smooth'});
    }

    function resetAll() {
        diagnosisData = null;
        resetUpload();
        els.resultsSection.classList.add('hidden');
        els.uploadSection.classList.remove('hidden');
        els.progressBar.style.width = '0%';
        window.scrollTo({top: 0, behavior: 'smooth'});
    }

    function downloadReport() {
        if (!diagnosisData) return;
        const report = {
            id: diagnosisData.trace_id,
            time: diagnosisData.timestamp,
            grade: diagnosisData.dr_grade_desc,
            lesion: diagnosisData.lesion_description,
            recommendations: diagnosisData.structured_report.recommendations,
            reasoning: diagnosisData.structured_report.cot_reasoning
        };
        const blob = new Blob([JSON.stringify(report, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `DR_Report_${diagnosisData.trace_id.slice(0,8)}.json`;
        a.click();
    }

    // --- Helpers ---
    function showToast(msg, type = 'info') {
        const toast = document.createElement('div');
        const colors = type === 'error' ? 'bg-red-500' : (type === 'success' ? 'bg-green-500' : 'bg-blue-600');
        toast.className = `${colors} text-white px-6 py-3 rounded-xl shadow-2xl flex items-center gap-3 fade-in-up min-w-[300px]`;
        toast.innerHTML = `<i class="fas ${type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i> ${msg}`;
        
        const container = $('toastContainer');
        container.appendChild(toast);
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    function getGradeColor(g) {
        return ['text-emerald-400', 'text-yellow-400', 'text-orange-400', 'text-red-400', 'text-red-600'][g] || 'text-white';
    }
    function getRiskColor(g) {
    }

    async function reloadKnowledgeBase() {
        try {
            const res = await fetch(`${getApiUrl()}/reload-knowledge-base`, {method: 'POST'});
            if(res.ok) showToast('知识库重载任务已启动', 'success');
            else throw new Error('Failed');
        } catch(e) {
            showToast('请求失败', 'error');
        }
    }

    function processFile(file) {
        if (!file || !file.type.startsWith('image/')) return showToast('请上传图片文件', 'error');
        if (file.size > 50 * 1024 * 1024) return showToast('图片过大 (>50MB)', 'error');

        currentFile = file;
        const reader = new FileReader();
        reader.onload = (e) => {
            els.previewImg.src = e.target.result;
            $('imageInfo').innerHTML = `<span>${file.name}</span><span>${(file.size/1024/1024).toFixed(2)} MB</span>`;
            
            $('uploadPlaceholder').classList.add('hidden');
            $('imagePreview').classList.remove('hidden');
            $('diagnoseBtn').disabled = false;
            els.dropZone.classList.add('border-blue-500', 'bg-slate-800/80');
        };
        reader.readAsDataURL(file);
    }

    function resetUpload() {
        currentFile = null;
        els.imageInput.value = '';
        $('uploadPlaceholder').classList.remove('hidden');
        $('imagePreview').classList.add('hidden');
        $('diagnoseBtn').disabled = true;
        els.dropZone.classList.remove('border-blue-500', 'bg-slate-800/80');
    }

    async function startDiagnosis() {
        if (!currentFile) return;

        // UI State
        $('diagnoseBtn').disabled = true;
        els.loadingState.classList.remove('hidden');
        els.uploadSection.classList.add('hidden');
        
        // Simulated Progress
        simulateProgress();

        try {
            const formData = new FormData();
            formData.append('file', currentFile);
            formData.append('enable_rag', $('enableRag').checked);
            formData.append('enable_cot', $('enableCot').checked);

            const res = await fetch(`${getApiUrl()}/diagnose`, {
                method: 'POST',
                body: formData
            });

            if (!res.ok) {
                const err = await res.json();
                throw new Error(err.detail || '诊断请求失败');
            }

            diagnosisData = await res.json();
            renderResults(diagnosisData);

        } catch (e) {
            console.error(e);
            showToast(e.message, 'error');
            // Reset UI on error
            els.loadingState.classList.add('hidden');
            els.uploadSection.classList.remove('hidden');
            $('diagnoseBtn').disabled = false;
        }
    }

    async function simulateProgress() {
        const steps = [
            { p: 10, t: '正在上传影像数据...' },
            { p: 30, t: 'ResNet152 正在进行 DR 分级...' },
            { p: 50, t: 'Qwen-VL 正在提取病灶特征...' },
            { p: 70, t: 'RAG 检索医学知识库...' },
            { p: 90, t: 'DeepSeek-R1 生成诊断报告...' }
        ];
        
        for(const step of steps) {
            if(diagnosisData) break; // Stop if done
            els.progressBar.style.width = step.p + '%';
            els.progressSteps.textContent = step.t;
            await new Promise(r => setTimeout(r, 800));
        }
    }

    function renderResults(data) {
        els.loadingState.classList.add('hidden');
        els.resultsSection.classList.remove('hidden');

        // Header Info
        $('traceId').textContent = data.trace_id;
        $('processTime').textContent = data.processing_time.toFixed(2) + 's';

        // 1. DR Grade
        const gradeEl = $('drGrade');
        // Display both numeric grade and description
        gradeEl.innerHTML = `\u003cspan class=\"text-2xl font-mono\"\u003e级别 ${data.dr_grade}\u003c/span\u003e\u003cbr\u003e${data.dr_grade_desc}`;
        gradeEl.className = `text-4xl font-bold mb-2 ${getGradeColor(data.dr_grade)}`;
        $('confidence').textContent = `置信度: ${(data.confidence * 100).toFixed(1)}%`;

        // 2. Risk Level
        $('riskLevel').textContent = getRiskLevel(data.dr_grade);
        $('riskLevel').className = `text-3xl font-bold mb-2 ${getRiskColor(data.dr_grade)}`;
        $('riskDesc').textContent = getRiskDesc(data.dr_grade);

        // 3. Lesion Description
        $('lesionDesc').textContent = data.lesion_description;

        // 4. Recommendations
        const recs = data.structured_report.recommendations || [];
        $('recommendations').innerHTML = recs.map(r => 
            `<li class="flex items-start gap-4 bg-slate-950/30 p-4 rounded-xl border border-slate-800/50 hover:border-emerald-500/30 transition-colors group">
                <div class="mt-0.5 w-5 h-5 rounded-full bg-emerald-500/10 flex items-center justify-center flex-shrink-0 group-hover:bg-emerald-500/20 transition-colors">
                    <i class="fas fa-check text-xs text-emerald-500"></i>
                </div>
                <span class="text-slate-300 text-sm leading-relaxed">${r}</span>
            </li>`
        ).join('');

        // 5. CoT Reasoning
        if (data.structured_report.cot_reasoning) {
            $('cotSection').classList.remove('hidden');
            $('cotReasoning').textContent = data.structured_report.cot_reasoning;
        } else {
            $('cotSection').classList.add('hidden');
        }

        // 6. Traceability
        if (data.structured_report.traceability) {
            $('traceSection').classList.remove('hidden');
            $('traceability').textContent = data.structured_report.traceability;
        } else {
            $('traceSection').classList.add('hidden');
        }

        // Scroll to top
        window.scrollTo({top: 0, behavior: 'smooth'});
    }

    function resetAll() {
        diagnosisData = null;
        resetUpload();
        els.resultsSection.classList.add('hidden');
        els.uploadSection.classList.remove('hidden');
        els.progressBar.style.width = '0%';
        window.scrollTo({top: 0, behavior: 'smooth'});
    }

    function downloadReport() {
        if (!diagnosisData) return;
        const report = {
            id: diagnosisData.trace_id,
            time: diagnosisData.timestamp,
            grade: diagnosisData.dr_grade_desc,
            lesion: diagnosisData.lesion_description,
            recommendations: diagnosisData.structured_report.recommendations,
            reasoning: diagnosisData.structured_report.cot_reasoning
        };
        const blob = new Blob([JSON.stringify(report, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `DR_Report_${diagnosisData.trace_id.slice(0,8)}.json`;
        a.click();
    }

    // --- Helpers ---
    function showToast(msg, type = 'info') {
        const toast = document.createElement('div');
        const colors = type === 'error' ? 'bg-red-500' : (type === 'success' ? 'bg-green-500' : 'bg-blue-600');
        toast.className = `${colors} text-white px-6 py-3 rounded-xl shadow-2xl flex items-center gap-3 fade-in-up min-w-[300px]`;
        toast.innerHTML = `<i class="fas ${type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i> ${msg}`;
        
        const container = $('toastContainer');
        container.appendChild(toast);
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    function getGradeColor(g) {
        return ['text-emerald-400', 'text-yellow-400', 'text-orange-400', 'text-red-400', 'text-red-600'][g] || 'text-white';
    }
    function getRiskColor(g) {
        return ['text-emerald-400', 'text-yellow-400', 'text-orange-400', 'text-red-400', 'text-red-600'][g] || 'text-white';
    }
    function getRiskLevel(g) { return ['低风险', '轻微', '中度', '高风险', '极高危'][g] || '未知'; }
    function getRiskDesc(g) { return ['未发现明显病变', '轻度非增殖期', '中度非增殖期', '重度非增殖期', '增殖期视网膜病变'][g]; }
    
    function getMetricIcon(key) {
        const icons = {
            'cpu_usage': 'fa-microchip',
            'memory_used': 'fa-memory',
            'memory_available': 'fa-box-open',
            'disk_usage': 'fa-hdd',
            'gpu_load': 'fa-tachometer-alt',
            'gpu_memory': 'fa-layer-group',
            'uptime': 'fa-clock',
            'models_loaded': 'fa-cubes',
            'local_models_loaded': 'fa-server',
            'api_services_active': 'fa-cloud',
            'system_mode': 'fa-cogs'
        };
        return icons[key.toLowerCase()] || 'fa-chart-bar';
    }

    // Start
    init();
  </script>
</body>
</html>